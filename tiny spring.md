# sugar spring

## ç¬¬0ç«  æ„Ÿè°¢

æ„Ÿè°¢å°å‚…å“¥åˆ†äº«çš„æ‰‹æ“springå®¹å™¨çš„æ•™ç¨‹,è¯¥mdç™¾åˆ†ä¹‹90æ–‡å­—éƒ½æ¥è‡ªå°å‚…å“¥çš„æ•™ç¨‹å½“ä¸­

## ç¬¬ä¸€ç«  spring å¯åŠ¨!

ä¸ºä»€ä¹ˆèµ·åä¸º sugar? çº¯ç²¹æ˜¯æƒ³è¹­hutoolçš„ç”œç”œçƒ­åº¦.é€šè¿‡å°å‚…å“¥çš„æ‰‹å†™springæ•™ç¨‹æ¥è®©è‡ªå·±æ›´å¥½ç†è§£springæ¡†æ¶ä»¥åŠå¼€å‘ä¸Šçš„æ€è·¯.
spring æ˜¯ä¸€ä¸ªè½»é‡çº§çš„éä¾µå…¥å¼ ioc (inversion of control/æ§åˆ¶ç¿»è½¬) ä¸ aop(Aspect Oriented Programming/é¢å‘åˆ‡é¢ç¼–ç¨‹)çš„å®¹å™¨æ¡†æ¶,
iocçš„ç®€è¦æ¦‚æ‹¬å°±æ˜¯å°†å¯¹è±¡çš„æ§åˆ¶æƒ(å¯¹è±¡çš„åˆ›å»º)äº¤ç»™å®¹å™¨æ¥é€‰æ‹©å‡ºæ¥,åœ¨æ­¤åŸºç¡€ä¸Šå¼€å‘å¯ä»¥é™ä½è€¦åˆ,æé«˜æ¨¡å—å†…èš.

> Spring åŒ…å«å¹¶ç®¡ç†åº”ç”¨å¯¹è±¡çš„é…ç½®å’Œç”Ÿå‘½å‘¨æœŸï¼Œåœ¨è¿™ä¸ªæ„ä¹‰ä¸Šå®ƒæ˜¯ä¸€ç§ç”¨äºæ‰¿è½½å¯¹è±¡çš„å®¹å™¨ï¼Œä½ å¯ä»¥é…ç½®ä½ çš„æ¯ä¸ª Bean å¯¹è±¡æ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„ï¼Œè¿™äº›
> Bean å¯ä»¥åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å®ä¾‹æˆ–è€…æ¯æ¬¡éœ€è¦æ—¶éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ç›¸äº’å…³è”æ„å»ºå’Œä½¿ç”¨çš„ã€‚

åœ¨springå½“ä¸­å­˜å‚¨åœ¨å®¹å™¨é‡Œé¢çš„beanå°±å¥½åƒé›¶ä»¶ä¸€æ ·è¢«ç»†åŒ–æ‹†é™¤ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯æœ‰åˆ©äºæˆ‘ä»¬å¯¹beanç®¡ç†ä»¥åŠ å¯¹å…¶è¿›è¡Œä¾èµ–æ³¨å…¥ç­‰æ“ä½œ

æœ¬ç« èŠ‚çš„ç›®çš„æ˜¯å®ç°ä¸€ä¸ªç®€å•çš„springå®¹å™¨ï¼ˆiocçš„å®¹å™¨ï¼‰ ç”¨æ¥å®šä¹‰ï¼Œå­˜å–å’Œè·å–beanå¯¹è±¡ã€‚

å‡¡æ˜¯å¯ä»¥å­˜æ”¾æ•°æ®çš„å…·ä½“æ•°æ®ç»“æ„å®ç°ï¼Œéƒ½å¯ä»¥ç§°ä¹‹ä¸ºå®¹å™¨ã€‚ä¾‹å¦‚ï¼šArrayListã€LinkedListã€HashSetç­‰ï¼Œåœ¨ä½¿ç”¨springæ—¶
æˆ‘ä»¬å¯ä»¥é€šè¿‡beanç±»å‹æˆ–è€…beanåç§°æ¥è·å–beanï¼Œå¯¹æ­¤ï¼ŒHashMapåº”è¯¥æ˜¯æœ€åˆé€‚çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚

å®šä¹‰ï¼šBeanDefinitionï¼Œå¯èƒ½è¿™æ˜¯ä½ åœ¨æŸ¥é˜… Spring æºç æ—¶ç»å¸¸çœ‹åˆ°çš„ä¸€ä¸ªç±»ï¼Œä¾‹å¦‚å®ƒä¼šåŒ…æ‹¬ singletonã€prototypeã€BeanClassName
ç­‰ã€‚ä½†ç›®å‰æˆ‘ä»¬åˆæ­¥å®ç°ä¼šæ›´åŠ ç®€å•çš„å¤„ç†ï¼Œåªå®šä¹‰ä¸€ä¸ª Object ç±»å‹ç”¨äºå­˜æ”¾å¯¹è±¡ã€‚
æ³¨å†Œï¼šè¿™ä¸ªè¿‡ç¨‹å°±ç›¸å½“äºæˆ‘ä»¬æŠŠæ•°æ®å­˜æ”¾åˆ° HashMap ä¸­ï¼Œåªä¸è¿‡ç°åœ¨ HashMap å­˜æ”¾çš„æ˜¯å®šä¹‰äº†çš„ Bean çš„å¯¹è±¡ä¿¡æ¯ã€‚
è·å–ï¼šæœ€åå°±æ˜¯è·å–å¯¹è±¡ï¼ŒBean çš„åå­—å°±æ˜¯keyï¼ŒSpring å®¹å™¨åˆå§‹åŒ–å¥½ Bean ä»¥åï¼Œå°±å¯ä»¥ç›´æ¥è·å–äº†ã€‚

åˆšå¼€å§‹æ—¶å¹¶æ²¡æœ‰å¤šå¤æ‚,springå®¹å™¨ä¹Ÿå°±æ˜¯ç”±beanDefinitionå’Œfactoryç»„æˆ.

BeanDefinition ç›¸å…³å±æ€§çš„å¡«å……ï¼Œä¾‹å¦‚ï¼šSCOPE_SINGLETONã€SCOPE_PROTOTYPEã€ROLE_APPLICATIONã€ROLE_SUPPORTã€ROLE_INFRASTRUCTURE ä»¥åŠ
Bean Class ä¿¡æ¯

## ç¬¬äºŒç«  å®ç° beançš„å®šä¹‰ä»¥åŠæ³¨å†Œ è·å–

å…³äºè®¾è®¡æ¨¡å¼çš„å®ç°ğŸ‘‡
>
æˆ‘ä»¬åœ¨æŠŠç³»ç»Ÿè®¾è®¡çš„è§†è§’èšç„¦åˆ°å…·ä½“ä»£ç å®ç°ä¸Šï¼Œä½ ä¼šæœ‰ä»€ä¹ˆæ‰‹æ®µæ¥å®ç°ä½ æƒ³è¦çš„è®¾è®¡æ¨¡å¼å‘¢ï¼Ÿå…¶å®ç¼–ç æ–¹å¼ä¸»è¦ä¾æ‰˜äºï¼šæ¥å£å®šä¹‰ã€ç±»å®ç°æ¥å£ã€æŠ½è±¡ç±»å®ç°æ¥å£ã€ç»§æ‰¿ç±»ã€ç»§æ‰¿æŠ½è±¡ç±»ï¼Œè€Œè¿™äº›æ“ä½œæ–¹å¼å¯ä»¥å¾ˆå¥½çš„éš”ç¦»å¼€æ¯ä¸ªç±»çš„åŸºç¡€åŠŸèƒ½ã€é€šç”¨åŠŸèƒ½å’Œä¸šåŠ¡åŠŸèƒ½ï¼Œå½“ç±»çš„èŒè´£æ¸…æ™°åï¼Œä½ çš„æ•´ä¸ªè®¾è®¡ä¹Ÿä¼šå˜å¾—å®¹æ˜“æ‰©å±•å’Œè¿­ä»£ã€‚

åœ¨ä¸Šä¸€ç« å®ç°äº†è·å–ä¸€ä¸ªå®ä¾‹åŒ–å¥½çš„bean,æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•å®ç°springçš„scopeåŠŸèƒ½ä¹Ÿå°±æ˜¯
prototypeå’Œsingletonä¸¤ç§æ¨¡å¼,åŒæ—¶å°†beançš„åˆ›å»ºäº¤ç»™å®¹å™¨,è€Œä¸æ˜¯è‡ªå·±å»åˆ›å»º.
> è¿™ä¸€æ¬¡æˆ‘ä»¬æŠŠ Bean çš„åˆ›å»ºäº¤ç»™å®¹å™¨ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨æ—¶å€™ä¼ é€’ä¸€ä¸ªå®ä¾‹åŒ–å¥½çš„ Bean
> å¯¹è±¡ï¼Œå¦å¤–è¿˜éœ€è¦è€ƒè™‘å•ä¾‹å¯¹è±¡ï¼Œåœ¨å¯¹è±¡çš„äºŒæ¬¡è·å–æ—¶æ˜¯å¯ä»¥ä»å†…å­˜ä¸­è·å–å¯¹è±¡çš„ã€‚æ­¤å¤–ä¸ä»…è¦å®ç°åŠŸèƒ½è¿˜éœ€è¦å®Œå–„åŸºç¡€å®¹å™¨æ¡†æ¶çš„ç±»ç»“æ„ä½“ï¼Œå¦åˆ™å°†æ¥å°±å¾ˆéš¾æ‰©å®¹è¿›å»å…¶ä»–çš„åŠŸèƒ½äº†ã€‚


> é¦–å…ˆéå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯åœ¨ Bean æ³¨å†Œçš„æ—¶å€™åªæ³¨å†Œä¸€ä¸ªç±»ä¿¡æ¯ï¼Œè€Œä¸ä¼šç›´æ¥æŠŠå®ä¾‹åŒ–ä¿¡æ¯æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚é‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹
> BeanDefinition ä¸­çš„å±æ€§ Object ä¸º Classï¼Œæ¥ä¸‹æ¥åœ¨éœ€è¦åšçš„å°±æ˜¯åœ¨è·å– Bean å¯¹è±¡æ—¶éœ€è¦å¤„ç† Bean
> å¯¹è±¡çš„å®ä¾‹åŒ–æ“ä½œä»¥åŠåˆ¤æ–­å½“å‰å•ä¾‹å¯¹è±¡åœ¨å®¹å™¨ä¸­æ˜¯å¦å·²ç»ç¼“å­˜èµ·æ¥äº†

ä¸Šé¢çš„æ˜¯é‡ç‚¹,æ¯•ç«Ÿä½ è‡ªå·±ä½¿ç”¨springæ—¶ä¹Ÿæ²¡æœ‰new å¯¹è±¡å°±èƒ½ç›´æ¥å¼€å§‹æ³¨å…¥ä½¿ç”¨ä¹‹.

è¿™ä¸€æ¬¡æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ å®ç°å•ä¾‹æ¨¡å¼,åŒæ—¶å°†BeanDefinitionæ”¹æˆåªæœ‰classç±»çš„å˜é‡,æŠŠç”Ÿæˆå®ä¾‹ç”©ç»™factoryæ¥å®ç°,è¿™æ ·æ›´æœ‰åˆ©äºç®¡ç†å·²ç»è‡ªå®šä¹‰åŒ–å®ä¾‹å¯¹è±¡

![img](https://bugstack.cn/assets/images/spring/spring-3-01.png)

> é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ BeanFactory è¿™æ ·ä¸€ä¸ª Bean å·¥å‚ï¼Œæä¾› Bean çš„è·å–æ–¹æ³• getBean(String name)ï¼Œä¹‹åè¿™ä¸ª Bean å·¥å‚æ¥å£ç”±æŠ½è±¡ç±»
> AbstractBeanFactory å®ç°ã€‚è¿™æ ·ä½¿ç”¨æ¨¡æ¿æ¨¡å¼ (opens new window)
> çš„è®¾è®¡æ–¹å¼ï¼Œå¯ä»¥ç»Ÿä¸€æ”¶å£é€šç”¨æ ¸å¿ƒæ–¹æ³•çš„è°ƒç”¨é€»è¾‘å’Œæ ‡å‡†å®šä¹‰ï¼Œä¹Ÿå°±å¾ˆå¥½çš„æ§åˆ¶äº†åç»­çš„å®ç°è€…ä¸ç”¨å…³å¿ƒè°ƒç”¨é€»è¾‘ï¼ŒæŒ‰ç…§ç»Ÿä¸€æ–¹å¼æ‰§è¡Œã€‚é‚£ä¹ˆç±»çš„ç»§æ‰¿è€…åªéœ€è¦å…³å¿ƒå…·ä½“æ–¹æ³•çš„é€»è¾‘å®ç°å³å¯ã€‚
> é‚£ä¹ˆåœ¨ç»§æ‰¿æŠ½è±¡ç±» AbstractBeanFactory åçš„ AbstractAutowireCapableBeanFactory å°±å¯ä»¥å®ç°ç›¸åº”çš„æŠ½è±¡æ–¹æ³•äº†ï¼Œå› ä¸º
> AbstractAutowireCapableBeanFactory æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥å®ƒåªä¼šå®ç°å±äºè‡ªå·±çš„æŠ½è±¡æ–¹æ³•ï¼Œå…¶ä»–æŠ½è±¡æ–¹æ³•ç”±ç»§æ‰¿
> AbstractAutowireCapableBeanFactory çš„ç±»å®ç°ã€‚è¿™é‡Œå°±ä½“ç°äº†ç±»å®ç°è¿‡ç¨‹ä¸­çš„å„å¸å…¶èŒï¼Œä½ åªéœ€è¦å…³å¿ƒå±äºä½ çš„å†…å®¹ï¼Œä¸æ˜¯ä½ çš„å†…å®¹ï¼Œä¸è¦å‚ä¸ã€‚è¿™ä¸€éƒ¨åˆ†å†…å®¹æˆ‘ä»¬ä¼šåœ¨ä»£ç é‡Œæœ‰å…·ä½“çš„ä½“ç°
> å¦å¤–è¿™é‡Œè¿˜æœ‰å—éå¸¸é‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œå°±æ˜¯å…³äºå•ä¾‹ SingletonBeanRegistry çš„æ¥å£å®šä¹‰å®ç°ï¼Œè€Œ DefaultSingletonBeanRegistry
> å¯¹æ¥å£å®ç°åï¼Œä¼šè¢«æŠ½è±¡ç±» AbstractBeanFactory ç»§æ‰¿ã€‚ç°åœ¨ AbstractBeanFactory
> å°±æ˜¯ä¸€ä¸ªéå¸¸å®Œæ•´ä¸”å¼ºå¤§çš„æŠ½è±¡ç±»äº†ï¼Œä¹Ÿèƒ½éå¸¸å¥½çš„ä½“ç°å‡ºå®ƒå¯¹æ¨¡æ¿æ¨¡å¼çš„æŠ½è±¡å®šä¹‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¸¦ç€è¿™äº›è®¾è®¡å±‚é¢çš„æ€è€ƒï¼Œå»çœ‹ä»£ç çš„å…·ä½“å®ç°ç»“æœ

ä»€ä¹ˆæ˜¯æ¨¡æ¿æ¨¡å¼?

åœ¨è®¾è®¡æ¨¡å¼ä¸Š,æ¨¡æ¿æ¨¡å¼å°±æ˜¯å°†è¦åšçš„æ–¹æ³•æŠ½è±¡åŒ– ç„¶åå°†ä»–ä»¬è¿›è¡Œæ’åº,å®ç°è½¬äº¤ç»™å­ç±»è¿›è¡Œã€‚
> å…³äºæ¨¡ç‰ˆæ¨¡å¼çš„æ ¸å¿ƒç‚¹åœ¨äºç”±æŠ½è±¡ç±»å®šä¹‰æŠ½è±¡æ–¹æ³•æ‰§è¡Œç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´çˆ¶ç±»è§„å®šäº†å¥½ä¸€ç³»åˆ—çš„æ‰§è¡Œæ ‡å‡†ï¼Œè¿™äº›æ ‡å‡†çš„ä¸²è”æˆä¸€æ•´å¥—ä¸šåŠ¡æµç¨‹ã€‚
> ä¸¾ä¸ªä¾‹å­ï¼Œçˆ¬å–è¿‡ç¨‹åˆ†ä¸ºï¼›æ¨¡æ‹Ÿç™»å½•ã€çˆ¬å–ä¿¡æ¯ã€ç”Ÿæˆæµ·æŠ¥ï¼Œè¿™ä¸‰ä¸ªæ­¥éª¤ï¼Œå¦å¤–
> å› ä¸ºæœ‰äº›å•†å“åªæœ‰ç™»å½•åæ‰å¯ä»¥çˆ¬å–ï¼Œå¹¶ä¸”ç™»å½•å¯ä»¥çœ‹åˆ°ä¸€äº›ç‰¹å®šçš„ä»·æ ¼è¿™ä¸æœªç™»å½•ç”¨æˆ·çœ‹åˆ°çš„ä»·æ ¼ä¸åŒã€‚
> ä¸åŒçš„ç”µå•†ç½‘ç«™çˆ¬å–æ–¹å¼ä¸åŒï¼Œè§£ææ–¹å¼ä¹Ÿä¸åŒï¼Œå› æ­¤å¯ä»¥ä½œä¸ºæ¯ä¸€ä¸ªå®ç°ç±»ä¸­çš„ç‰¹å®šå®ç°ã€‚
> ç”Ÿæˆæµ·æŠ¥çš„æ­¥éª¤åŸºæœ¬ä¸€æ ·ï¼Œä½†ä¼šæœ‰ç‰¹å®šçš„å•†å“æ¥æºæ ‡è¯†ã€‚æ‰€ä»¥è¿™æ ·ä¸‰ä¸ªæ­¥éª¤å¯ä»¥ä½¿ç”¨æ¨¡ç‰ˆæ¨¡å¼æ¥è®¾å®šï¼Œå¹¶æœ‰å…·ä½“çš„åœºæ™¯åšå­ç±»å®ç°
> ä»–å¯ä»¥æ§åˆ¶æ•´å¥—é€»è¾‘çš„æ‰§è¡Œé¡ºåºå’Œç»Ÿä¸€çš„è¾“å…¥ã€è¾“å‡ºï¼Œè€Œå¯¹äºå®ç°æ–¹åªéœ€è¦å…³å¿ƒå¥½è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å³å¯ã€‚

![å›¾ 3-2](https://bugstack.cn/assets/images/spring/spring-3-02.png)

> - BeanFactory çš„å®šä¹‰ç”± AbstractBeanFactory æŠ½è±¡ç±»å®ç°æ¥å£çš„ getBean æ–¹æ³•
> - è€Œ AbstractBeanFactory åˆç»§æ‰¿äº†å®ç°äº† SingletonBeanRegistry çš„DefaultSingletonBeanRegistry ç±»ã€‚è¿™æ ·
    AbstractBeanFactory æŠ½è±¡ç±»å°±å…·å¤‡äº†å•ä¾‹ Bean çš„æ³¨å†ŒåŠŸèƒ½ã€‚
> - AbstractBeanFactory ä¸­åˆå®šä¹‰äº†ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼šgetBeanDefinition(String beanName)ã€createBean(String beanName,
    BeanDefinition beanDefinition) ï¼Œè€Œè¿™ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•åˆ†åˆ«ç”± DefaultListableBeanFactoryã€AbstractAutowireCapableBeanFactory
    å®ç°ã€‚
> - æœ€ç»ˆ DefaultListableBeanFactory è¿˜ä¼šç»§æ‰¿æŠ½è±¡ç±» AbstractAutowireCapableBeanFactory ä¹Ÿå°±å¯ä»¥è°ƒç”¨æŠ½è±¡ç±»ä¸­çš„ createBean
    æ–¹æ³•äº†ã€‚



æˆ‘ä»¬ä»æœ€é¡¶å±‚å¼€å§‹å¾€ä¸‹åˆ†æ
é¦–å…ˆæ˜¯ BeanFactoryæ¥å£,å®ƒçš„ä½œç”¨æ˜¯ç»™æˆ‘ä»¬æ¨¡æ¿æ¨¡å¼çš„æ¨¡æ¿ AbstractFactoryä¸€ä¸ªgetBeançš„æ–¹æ³•,ç„¶åæ˜¯å…³äºå•ä¾‹æ¨¡å¼çš„ä¸»ä»¶:
SingletonRegistry
å’Œå®ç°å®ƒçš„DefaultSingletonRegistry.å‰è€…æä¾›äº†getSingletonçš„æ–¹æ³•,åè€…å°†å…¶å®ç°å¹¶ä¸”ç»´æŠ¤ç€ä¸€ä¸ªå­˜å‚¨ç€Singletonæ¨¡å¼Beançš„ç¼“å­˜Map,åŒæ—¶è¿˜å®ç°äº†ä¸€ä¸ªaddSingletonBeançš„æ–¹æ³•.

ç„¶åæ˜¯"æ¨¡æ¿ç±»" AbstractFactory å®ƒæ˜¯è´Ÿè´£å°†getBeanç±»å®ç°çš„åŒæ—¶å®‰æ’å¥½æŠ½è±¡æ–¹æ³•æ‰§è¡Œé¡ºåºçš„æ ¸å¿ƒ.ä»–å°†creatBeanå’ŒgetBeanDefinitionæ–¹æ³•å¤–åŒ…ç»™å­ç±»æ¥åš.
æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯,å®ƒçš„å­ç±»éƒ½æ˜¯åˆ†å·¥åˆä½œå„è‡ªå®ç°ä¸åŒçš„æŠ½è±¡æ–¹æ³• åœ¨ä¸€å®šç¨‹åº¦ä¸Šç›¸äº’éš”ç¦»,èŒè´£åˆ†æ˜;
> ç»¼ä¸Šè¿™ä¸€éƒ¨åˆ†çš„ç±»å…³ç³»å’Œå®ç°è¿‡ç¨‹è¿˜æ˜¯ä¼šæœ‰ä¸€äº›å¤æ‚çš„ï¼Œå› ä¸ºæ‰€æœ‰çš„å®ç°éƒ½ä»¥èŒè´£åˆ’åˆ†ã€å…±æ€§åˆ†ç¦»ä»¥åŠè°ƒç”¨å…³ç³»å®šä¹‰ä¸ºæ ‡å‡†æ­å»ºçš„ç±»å…³ç³»ã€‚è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ ï¼Œå¯èƒ½ä¼šä¸°å¯Œä½ åœ¨å¤æ‚ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸­çš„è®¾è®¡æ€è·¯ã€‚

å…¶ä¸­æŠ½è±¡ç±»AbstractAutowireCapableBeanFactoryå®ç°çš„æ˜¯createBeanéƒ¨åˆ†çš„å†…å®¹,
DefaultListableBeanFactoryæ˜¯æ ¸å¿ƒå®ç°ç±»,å®ç°çš„æ˜¯getBeanDefinitionçš„æ–¹æ³•å¹¶ç»´æŠ¤ç€ä¸€ä¸ªå…³äºBeanDefinitionçš„Map,åŒæ—¶å®ç°äº†æ¥å£BeanDefinitionRegistryçš„registerDefinitionæ–¹æ³•.
> DefaultListableBeanFactory åœ¨ Spring æºç ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„ç±»ï¼Œåœ¨æˆ‘ä»¬ç›®å‰çš„å®ç°ä¸­ä¹Ÿæ˜¯é€æ­¥è´´è¿‘äºæºç ï¼Œä¸æºç ç±»åä¿æŒä¸€è‡´ã€‚
> DefaultListableBeanFactory ç»§æ‰¿äº† AbstractAutowireCapableBeanFactory ç±»ï¼Œä¹Ÿå°±å…·å¤‡äº†æ¥å£ BeanFactory å’Œ
> AbstractBeanFactory ç­‰ä¸€è¿ä¸²çš„åŠŸèƒ½å®ç°ã€‚æ‰€ä»¥æœ‰æ—¶å€™ä½ ä¼šçœ‹åˆ°ä¸€äº›ç±»çš„å¼ºè½¬ï¼Œè°ƒç”¨æŸäº›æ–¹æ³•ï¼Œä¹Ÿæ˜¯å› ä¸ºä½ å¼ºè½¬çš„ç±»å®ç°æ¥å£æˆ–ç»§æ‰¿äº†æŸäº›ç±»ã€‚
> é™¤æ­¤ä¹‹å¤–è¿™ä¸ªç±»è¿˜å®ç°äº†æ¥å£ BeanDefinitionRegistry ä¸­çš„ registerBeanDefinition(String beanName, BeanDefinition
> beanDefinition) æ–¹æ³•ï¼Œå½“ç„¶ä½ è¿˜ä¼šçœ‹åˆ°ä¸€ä¸ª getBeanDefinition çš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬æ–‡ä¸­æåˆ°è¿‡å®ƒæ˜¯æŠ½è±¡ç±» AbstractBeanFactory
> ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ã€‚ç°åœ¨æ³¨å†ŒBeanå®šä¹‰ä¸è·å–Beanå®šä¹‰å°±å¯ä»¥åŒæ—¶ä½¿ç”¨äº†ï¼Œæ˜¯ä¸æ„Ÿè§‰è¿™ä¸ªå¥—è·¯è¿˜è›®æ·±çš„ã€‚æ¥å£å®šä¹‰äº†æ³¨å†Œï¼ŒæŠ½è±¡ç±»å®šä¹‰äº†è·å–ï¼Œéƒ½é›†ä¸­åœ¨
> DefaultListableBeanFactory ä¸­çš„ beanDefinitionMap é‡Œ

ğŸ‘†æ¥å£å®šä¹‰äº†æ³¨å†Œ(SingletonRegistryå’ŒBeanDefinitionRegistry)ï¼ŒæŠ½è±¡ç±»å®šä¹‰äº†è·å–(getBeanå’ŒgetBeanDefinition)

å…¶ä¸­AbstractAutowireCapableBeanFactoryçš„createæ–¹æ³•å½“ä¸­æœ‰ç¼ºé™·,åªèƒ½ç”Ÿæˆæ— å‚æ„é€ çš„bean,ä¸‹ä¸€ç« å†™è§£å†³æ–¹æ¡ˆ.
åœ¨BeanFactoryå½“ä¸­æˆ‘ä»¬å‘ç°getBeanæ˜¯ä¼˜å…ˆå»è·å–singletonMapé‡Œé¢çš„bean,å¦‚æœæ²¡æœ‰æ‰è‡ªå·±å»åˆ›å»º.

æ€»ç»“:
å­¦åˆ°äº†æ¨¡æ¿æ¨¡å¼çš„åº”ç”¨ éµå¾ªå¼€é—­åŸåˆ™,å°†èŒè´£åˆ’åˆ†å¥½ åˆ†å¥½å±‚,é€ä¸ªå»å®ç°(æ¯”å¦‚"æ³¨å†Œ"ç”¨æ¥å£æ¥å®šä¹‰,"è·å–"ç”¨ç±»æ¥å®ç°)
> å°å‚…å“¥çš„æ€»ç»“:ç›¸å¯¹äº å‰ä¸€ç« èŠ‚ å¯¹ Spring Bean
> å®¹å™¨çš„ç®€å•æ¦‚å¿µå®ç°ï¼Œæœ¬ç« èŠ‚ä¸­åŠ å¼ºäº†åŠŸèƒ½çš„å®Œå–„ã€‚åœ¨å®ç°çš„è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç±»çš„å…³ç³»å˜å¾—è¶Šæ¥è¶Šå¤šäº†ï¼Œå¦‚æœæ²¡æœ‰åšè¿‡ä¸€äº›ç¨å¾®å¤æ‚çš„ç³»ç»Ÿç±»ç³»ç»Ÿï¼Œé‚£ä¹ˆå³ä½¿ç°åœ¨è¿™æ ·9ä¸ªç±»æ­å‡ºæ¥çš„å®¹å™¨å·¥å‚ä¹Ÿå¯ä»¥ç»™ä½ ç»•æ™•ã€‚
> åœ¨ Spring Bean å®¹å™¨çš„å®ç°ç±»ä¸­è¦é‡ç‚¹å…³æ³¨ç±»ä¹‹é—´çš„èŒè´£å’Œå…³ç³»ï¼Œå‡ ä¹æ‰€æœ‰çš„ç¨‹åºåŠŸèƒ½è®¾è®¡éƒ½ç¦»ä¸å¼€æ¥å£ã€æŠ½è±¡ç±»ã€å®ç°ã€ç»§æ‰¿ï¼Œè€Œè¿™äº›ä¸åŒç‰¹æ€§ç±»çš„ä½¿ç”¨å°±å¯ä»¥éå¸¸å¥½çš„éš”ç¦»å¼€ç±»çš„åŠŸèƒ½èŒè´£å’Œä½œç”¨èŒƒå›´ã€‚è€Œè¿™æ ·çš„çŸ¥è¯†ç‚¹ä¹Ÿæ˜¯åœ¨å­¦ä¹ æ‰‹å†™
> Spring Bean å®¹å™¨æ¡†æ¶è¿‡ç¨‹éå¸¸é‡è¦çš„çŸ¥è¯†ã€‚
>
æœ€åè¦å¼ºè°ƒä¸€ä¸‹å…³äºæ•´ä¸ªç³»åˆ—å†…å®¹çš„å­¦ä¹ ï¼Œå¯èƒ½åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°åƒç¬¬äºŒç« èŠ‚é‚£æ ·éå¸¸ç®€å•çš„ä»£ç å®ç°ï¼Œä½†è¦åšä¸€ä¸ªæœ‰æˆé•¿çš„ç¨‹åºå‘˜è¦è®°ä½ä»£ç å®ç°åªæ˜¯æœ€åçš„è½åœ°ç»“æœï¼Œè€Œé‚£äº›è®¾è®¡ä¸Šçš„æ€è€ƒæ‰æ˜¯æœ€æœ‰ä»·å€¼çš„åœ°æ–¹ã€‚å°±åƒä½ æ˜¯å¦é‡åˆ°è¿‡ï¼Œæœ‰äººè®©ä½ ç»™ä¸€ä¸ªå†…å®¹åšä¸ªæè¿°ã€æ–‡æ¡£ã€è¯´æ˜ï¼Œä½ æ€»è§‰å¾—å¤ªç®€å•äº†æ²¡ä»€ä¹ˆå¯å†™çš„ï¼Œå³ä½¿è¦åŠ¨ç¬”å†™äº†ä¹Ÿä¸çŸ¥é“è¦ä»å“ªå¼€å§‹ï¼å…¶å®è¿™äº›çŸ¥è¯†å†…å®¹éƒ½æ¥æºä½ å¯¹æ•´ä½“åŠŸèƒ½çš„ç†è§£ï¼Œè¿™å°±ä¸åªæ˜¯ä»£ç å¼€å‘è¿˜åŒ…æ‹¬äº†éœ€æ±‚ç›®æ ‡ã€æ–¹æ¡ˆè®¾è®¡ã€æŠ€æœ¯å®ç°ã€é€»è¾‘éªŒè¯ç­‰ç­‰è¿‡ç¨‹æ€§çš„å†…å®¹ã€‚æ‰€ä»¥ï¼Œä¸è¦åªæ˜¯è¢«çœ‹ä¼¼ç®€å•çš„å†…å®¹å¿½ç•¥äº†æ•´ä½“å…¨å±€è§‚ï¼Œè¦å­¦ä¼šæ”¾å¼€è§†é‡ï¼Œå¼€æ”¾å­¦ä¹ è§†è§’ã€‚

## ç¬¬ä¸‰ç«  å®ç°jdkå’Œcglibçš„å®ä¾‹åŒ–å¯¹è±¡è¡¥å……

å‰ç½®çŸ¥è¯†è¦æ±‚:æ˜ç™½cglibå’Œjdkä»£ç†çš„åŸç†ä»¥åŠä½¿ç”¨æ–¹å¼.
åœ¨ä¸Šä¸€ç« å½“ä¸­æˆ‘ä»¬åœ¨AbstractAutowireCapableBeanFactoryå½“ä¸­å®ç°çš„åˆ›å»ºbeanæ–¹æ³•åªèƒ½è°ƒç”¨æ— å‚æ„é€ 

### è®¾è®¡

è®¾è®¡ä¸Šé¢æœ‰ä¸¤ä¸ªé—®é¢˜,ä¸€,åœ¨**å“ªä¸ªé˜¶æ®µ**åˆé€‚åœ°è¿›è¡Œå‚æ•°åˆ¤æ–­é€‰æ‹©æ„é€ å™¨? äºŒ,æ€ä¹ˆå»å®ä¾‹åŒ–æ„é€ bean
> Spring Bean å®¹å™¨æºç çš„å®ç°æ–¹å¼ï¼Œåœ¨ BeanFactory ä¸­æ·»åŠ  Object getBean(String name, Object... args) æ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è·å–
> Bean æ—¶æŠŠæ„é€ å‡½æ•°çš„å…¥å‚ä¿¡æ¯ä¼ é€’è¿›å»äº†ã€‚

é€šè¿‡javaçš„ä¸å®šé•¿å‚æ•° æ¥åšåˆ°è¾“å…¥ä¸åŒå‚æ•°æ¥é€‰æ‹©æ„é€ å™¨(åŸæœ¬ä»¥ä¸ºä¸å®šé•¿å‚æ•°åªèƒ½é’ˆå¯¹ä¸€ä¸ªç±»å‹,æ²¡æƒ³åˆ°é…åˆObjectç‰¹æ€§å¯ä»¥æµ·çº³ç™¾å·)

å°±å¼•å‡ºäº†cglibå’Œjdkå®ä¾‹åŒ–äº†

![å›¾ 4-2](https://bugstack.cn/assets/images/spring/spring-4-02.png)

> æœ¬ç« èŠ‚â€œå¡«å‘â€ä¸»è¦æ˜¯åœ¨ç°æœ‰å·¥ç¨‹ä¸­æ·»åŠ  InstantiationStrategy å®ä¾‹åŒ–ç­–ç•¥æ¥å£ï¼Œä»¥åŠè¡¥å……ç›¸åº”çš„ getBean
> å…¥å‚ä¿¡æ¯ï¼Œè®©å¤–éƒ¨è°ƒç”¨æ—¶å¯ä»¥ä¼ é€’æ„é€ å‡½æ•°çš„å…¥å‚å¹¶é¡ºåˆ©å®ä¾‹åŒ–

é€šè¿‡æºç ,æˆ‘ä»¬åœ¨abstractFactoryé‡Œé¢å®ç°äº†ä¸¤ä¸ªbeançš„è·å–,åŒæ—¶æ•´åˆåˆ°doGetBeanæ–¹æ³•é‡Œé¢,åˆ©ç”¨æ¨¡æ¿æ¨¡å¼è¿›è¡Œé›†åˆ.

å…¶ä¸­å…³äºcglibçš„å®ä¾‹åŒ–æ˜¯å»ºç«‹ä»£ç†ç±»çš„åŸºç¡€ä¸Šç”¨NoOpçš„æ–¹æ³•ä¸ä»£ç†è¿›è¡Œå®ç°ã€‚è€Œjdkå®ä¾‹åŒ–åˆ™æ˜¯åˆ©ç”¨äº†åå°„ä½œä¸ºå®ç°çš„æ–¹å¼

æˆ‘ä»¬å°†getBeanæ–¹æ³•è¿›è¡Œé‡è½½ä»¥åŠé›†åˆå¥½doGetBeanå½“ä¸­,å¹¶å°†AbstractAutowireCapableBeanFactoryå½“ä¸­çš„createBean1æ–¹æ³•è¿›è¡Œ
é‡å†™,å°†å®ç°instantiateStrategyæ¥å£çš„cglibå’Œjdkå®ä¾‹åŒ–ä½œä¸ºcreateBeanå½“ä¸­çš„åˆ›å»ºå®ä¾‹çš„æ–¹æ³•;

ç›®å‰æˆ‘ä»¬åˆ›å»ºçš„beanè¿˜æ˜¯å­˜å‚¨åœ¨singletonå½“ä¸­;

æˆ‘ä»¬é»˜è®¤ä½¿ç”¨çš„æ˜¯Cglibçš„ä½œä¸ºåˆ›å»ºçš„æ–¹æ³•.åœ¨createBeanInstanceå½“ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é€šè¿‡é•¿åº¦æ¥åˆ¤åˆ«é€‰æ‹©çš„æ„é€ å™¨,ä½†å®é™…ä¸Šæ˜¯ä¸ä¸¥è°¨çš„,å› ä¸ºå¯èƒ½ä¼šå‡ºç°
ç±»å‹ä¸ä¸€è‡´çš„çŠ¶å†µ,ä¸ºæ­¤å¯ä»¥åœ¨åŸæœ‰åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹;

> å…¶ä¸­ Constructor ä½ å¯èƒ½ä¼šæœ‰ä¸€ç‚¹é™Œç”Ÿï¼Œå®ƒæ˜¯ java.lang.reflect åŒ…ä¸‹çš„ Constructor
> ç±»ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›å¿…è¦çš„ç±»ä¿¡æ¯ï¼Œæœ‰è¿™ä¸ªå‚æ•°çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ‹¿åˆ°ç¬¦åˆå…¥å‚ä¿¡æ¯ç›¸å¯¹åº”çš„æ„é€ å‡½æ•°
> å…¶å® Cglib åˆ›å»ºæœ‰æ„é€ å‡½æ•°çš„ Bean ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ›´åŠ ç®€åŒ–çš„å¤„ç†äº†ï¼Œå¦‚æœä½ é˜…è¯» Spring æºç è¿˜ä¼šçœ‹åˆ° CallbackFilter
> ç­‰å®ç°ï¼Œä¸è¿‡æˆ‘ä»¬ç›®å‰çš„æ–¹å¼å¹¶ä¸ä¼šå½±å“åˆ›å»ºã€‚

> æ¥ä¸‹æ¥å°±éœ€è¦å¾ªç¯æ¯”å¯¹å‡ºæ„é€ å‡½æ•°é›†åˆä¸å…¥å‚ä¿¡æ¯ args çš„åŒ¹é…æƒ…å†µï¼Œè¿™é‡Œæˆ‘ä»¬å¯¹æ¯”çš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯ä¸€ä¸ªæ•°é‡å¯¹æ¯”ï¼Œè€Œå®é™… Spring
> æºç ä¸­è¿˜éœ€è¦æ¯”å¯¹å…¥å‚ç±»å‹ï¼Œå¦åˆ™ç›¸åŒæ•°é‡ä¸åŒå…¥å‚ç±»å‹çš„æƒ…å†µï¼Œå°±ä¼šæŠ›å¼‚å¸¸äº†ã€‚

> å°å‚…å“¥æ€»ç»“:
> æœ¬ç« èŠ‚çš„ä¸»è¦ä»¥å®Œå–„å®ä¾‹åŒ–æ“ä½œï¼Œå¢åŠ  InstantiationStrategy å®ä¾‹åŒ–ç­–ç•¥æ¥å£ï¼Œå¹¶æ–°å¢äº†ä¸¤ä¸ªå®ä¾‹åŒ–ç±»ã€‚è¿™éƒ¨åˆ†ç±»çš„åç§°ä¸å®ç°æ–¹å¼åŸºæœ¬æ˜¯
> Spring æ¡†æ¶çš„ä¸€ä¸ªç¼©å°ç‰ˆï¼Œå¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥ä» Spring æºç æ‰¾åˆ°å¯¹åº”çš„ä»£ç ã€‚
>
ä»æˆ‘ä»¬ä¸æ–­çš„å®Œå–„å¢åŠ éœ€æ±‚å¯ä»¥çœ‹åˆ°çš„ï¼Œå½“ä½ çš„ä»£ç ç»“æ„è®¾è®¡çš„è¾ƒä¸ºåˆç†çš„æ—¶å€™ï¼Œå°±å¯ä»¥éå¸¸å®¹æ˜“ä¸”æ–¹ä¾¿çš„è¿›è¡Œæ‰©å±•ä¸åŒå±æ€§çš„ç±»èŒè´£ï¼Œè€Œä¸ä¼šå› ä¸ºéœ€æ±‚çš„å¢åŠ å¯¼è‡´ç±»ç»“æ„æ··ä¹±ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬è‡ªå·±ä¸šåŠ¡éœ€æ±‚å®ç°çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè¦å°½å¯èƒ½çš„å»è€ƒè™‘ä¸€ä¸ªè‰¯å¥½çš„æ‰©å±•æ€§ä»¥åŠæ‹†åˆ†å¥½ç±»çš„èŒè´£ã€‚

## ç¬¬å››ç«  æ³¨å…¥å±æ€§å’Œä¾èµ–beanæ³¨å…¥çš„å®ç°

> åœ¨åˆ›å»ºå¯¹è±¡å®ä¾‹åŒ–è¿™æˆ‘ä»¬è¿˜ç¼ºå°‘ä»€ä¹ˆï¼Ÿå…¶å®è¿˜ç¼ºå°‘ä¸€ä¸ªå…³äºç±»ä¸­æ˜¯å¦æœ‰å±æ€§çš„é—®é¢˜ï¼Œå¦‚æœæœ‰ç±»ä¸­åŒ…å«å±æ€§é‚£ä¹ˆåœ¨å®ä¾‹åŒ–çš„æ—¶å€™å°±éœ€è¦æŠŠå±æ€§ä¿¡æ¯å¡«å……ä¸Šï¼Œè¿™æ ·æ‰æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡åˆ›å»ºã€‚å¯¹äºå±æ€§çš„å¡«å……ä¸åªæ˜¯
> intã€Longã€Stringï¼Œè¿˜åŒ…æ‹¬è¿˜æ²¡æœ‰å®ä¾‹åŒ–çš„å¯¹è±¡å±æ€§ï¼Œéƒ½éœ€è¦åœ¨ Bean åˆ›å»ºæ—¶è¿›è¡Œå¡«å……æ“ä½œã€‚ä¸è¿‡è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸ä¼šè€ƒè™‘ Bean
> çš„å¾ªç¯ä¾èµ–ï¼Œå¦åˆ™ä¼šæŠŠæ•´ä¸ªåŠŸèƒ½å®ç°æ’‘å¤§ï¼Œè¿™æ ·æ–°äººå­¦ä¹ æ—¶å°±æŠŠæ¡ä¸ä½äº†ï¼Œå¾…åç»­é™†ç»­å…ˆæŠŠæ ¸å¿ƒåŠŸèƒ½å®ç°åï¼Œå†é€æ­¥å®Œå–„

ä¹Ÿå°±æ˜¯ç±»çš„é»˜è®¤å±æ€§å’Œä¾èµ–æ³¨å…¥.

![img](https://bugstack.cn/assets/images/spring/spring-5-01.png)

å±æ€§å¡«å……å¾—åœ¨å®ä¾‹åˆ›å»ºä¹‹åè¿›è¡Œ,ä¹Ÿå°±æ˜¯AbstractAutowireCapableBeanFactoryå½“å®Œæˆ createBean ä¸­è¿›è¡Œ applyPropertyValue;

> ç”±äºæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºBeanæ—¶å€™å¡«å……å±æ€§æ“ä½œï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ bean å®šä¹‰ BeanDefinition ç±»ä¸­ï¼Œæ·»åŠ  PropertyValues ä¿¡æ¯ã€‚
> å¦å¤–æ˜¯å¡«å……å±æ€§ä¿¡æ¯è¿˜åŒ…æ‹¬äº† Bean çš„å¯¹è±¡ç±»å‹ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å†å®šä¹‰ä¸€ä¸ª BeanReferenceï¼Œé‡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„ Bean
> åç§°ï¼Œåœ¨å…·ä½“çš„å®ä¾‹åŒ–æ“ä½œæ—¶è¿›è¡Œé€’å½’åˆ›å»ºå’Œå¡«å……ï¼Œä¸ Spring æºç å®ç°ä¸€æ ·ã€‚Spring æºç ä¸­ BeanReference æ˜¯ä¸€ä¸ªæ¥å£

![å›¾ 5-2](https://bugstack.cn/assets/images/spring/spring-5-02.png)

> ç”±äºæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»ºBeanæ—¶å€™å¡«å……å±æ€§æ“ä½œï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ bean å®šä¹‰ BeanDefinition ç±»ä¸­ï¼Œæ·»åŠ  PropertyValues ä¿¡æ¯ã€‚
> å¦å¤–æ˜¯å¡«å……å±æ€§ä¿¡æ¯è¿˜åŒ…æ‹¬äº† Bean çš„å¯¹è±¡ç±»å‹ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å†å®šä¹‰ä¸€ä¸ª BeanReferenceï¼Œé‡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„ Bean
> åç§°ï¼Œåœ¨å…·ä½“çš„å®ä¾‹åŒ–æ“ä½œæ—¶è¿›è¡Œé€’å½’åˆ›å»ºå’Œå¡«å……ï¼Œä¸ Spring æºç å®ç°ä¸€æ ·ã€‚Spring æºç ä¸­ BeanReference æ˜¯ä¸€ä¸ªæ¥å£

å­¦åˆ°çš„å°tip:

åœ¨foreachéå†å½“ä¸­,åªè¦listä¸ºç©ºåˆ—è¡¨å’Œé›†åˆé•¿åº¦ä¸º0,å°±ä¸ä¼šè¿›å…¥åˆ°ä»£ç å—å½“ä¸­;

---
æˆ‘ä»¬åˆ›å»ºäº†PropertyValueå’ŒPropertyValuesç›®çš„æ˜¯ä¸ºäº†å°†æ³¨å…¥beançš„å±æ€§å­—æ®µæ”¶é›†èµ·æ¥å¤„ç† å…¶ä¸­PropertyValueçš„value
åŒ…å«äº†åŸºæœ¬ç±»å‹ä¸å¼•ç”¨ç±»å‹,é€šè¿‡åå°„æ³¨å…¥.åŒæ—¶å°†PropertyValues
è®¾ç½®ä¸ºBeanDefinitionçš„å±æ€§ä½œä¸ºæ³¨å…¥æ—¶çš„å‚æ•°;
> è¿™ä¸¤ä¸ªç±»çš„ä½œç”¨å°±æ˜¯åˆ›å»ºå‡ºä¸€ä¸ªç”¨äºä¼ é€’ç±»ä¸­å±æ€§ä¿¡æ¯çš„ç±»ï¼Œå› ä¸ºå±æ€§å¯èƒ½ä¼šæœ‰å¾ˆå¤šï¼Œæ‰€ä»¥è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªé›†åˆåŒ…è£…ä¸‹ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰å»å¤„ç†å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¾ƒå¤§ï¼Œåç»­è¡¥å……

åˆ›å»ºBeanReferenceæ˜¯ä¸ºå¤„ç†å±æ€§å½“ä¸­æœ‰beançš„å­˜åœ¨,ä¸ºä»€ä¹ˆä¸ç›´æ¥é€šè¿‡åå°„è¯†åˆ«å‡ºå±æ€§åå­—ä¹‹åæ¥æ³¨å…¥è€Œæ˜¯é€šè¿‡BeanReferenceæ¥ä½œä¸ºå¼•ç”¨æ³¨å…¥?

ç­”æ¡ˆæ˜¯é€»è¾‘å¤„ç†èµ·æ¥å¾ˆéº»çƒ¦,è€Œä¸”ä¹Ÿä¸simple,å¯è¯»æ€§ä¼°è®¡å¾ˆshit;

## ç¬¬äº”ç«  è®¾è®¡ä¸å®ç°èµ„æºåŠ è½½å™¨ï¼Œä»Spring.xmlè§£æå’Œæ³¨å†ŒBeanå¯¹è±¡

> åœ¨æˆ‘ä»¬å®ç°çš„ Spring
>
æ¡†æ¶ä¸­ï¼Œæ¯ä¸€ä¸ªç« èŠ‚éƒ½ä¼šç»“åˆä¸Šä¸€ç« èŠ‚ç»§ç»­æ‰©å±•åŠŸèƒ½ï¼Œå°±åƒæ¯ä¸€æ¬¡äº§å“éƒ½åœ¨åŠ éœ€æ±‚ä¸€æ ·ï¼Œé‚£ä¹ˆåœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­å¯ä»¥æ‰¿ä¸Šå¯ä¸‹çš„å¯¹ç…§å’Œå‚è€ƒï¼Œçœ‹çœ‹æ¯ä¸€ä¸ªæ¨¡å—çš„æ·»åŠ éƒ½æ˜¯ç”¨ä»€ä¹ˆé€»è¾‘å’ŒæŠ€æœ¯ç»†èŠ‚å®ç°çš„ã€‚è¿™äº›å†…å®¹çš„å­¦ä¹ ï¼Œä¼šéå¸¸æœ‰åˆ©äºä½ ä»¥ååœ¨è®¾è®¡å’Œå®ç°ï¼Œè‡ªå·±æ‰¿æ¥äº§å“éœ€æ±‚æ—¶åšçš„å…·ä½“å¼€å‘ï¼Œä»£ç çš„è´¨é‡ä¹Ÿä¼šè¶Šæ¥è¶Šé«˜ï¼Œè¶Šæ¥è¶Šæœ‰æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§

![img](https://bugstack.cn/assets/images/spring/spring-6-02.png)

è®¾è®¡

æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†ä¸‰ç§ç±»å‹çš„èµ„æºè§£æå™¨è¿›è¡Œå®ç°ï¼Œå°†æ•°æ®è¯»å–ä¹‹åè¿›è¡Œè§£æå’Œæ³¨å†Œåˆ°springçš„å®¹å™¨å½“ä¸­ã€‚

> - èµ„æºåŠ è½½å™¨å±äºç›¸å¯¹ç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œå®ƒä½äº Spring æ¡†æ¶æ ¸å¿ƒåŒ…ä¸‹çš„IOå®ç°å†…å®¹ï¼Œä¸»è¦ç”¨äºå¤„ç†Classã€æœ¬åœ°å’Œäº‘ç¯å¢ƒä¸­çš„æ–‡ä»¶ä¿¡æ¯ã€‚
> - å½“èµ„æºå¯ä»¥åŠ è½½åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£æå’Œæ³¨å†Œ Bean åˆ° Spring ä¸­çš„æ“ä½œï¼Œè¿™éƒ¨åˆ†å®ç°éœ€è¦å’Œ DefaultListableBeanFactory
    æ ¸å¿ƒç±»ç»“åˆèµ·æ¥ï¼Œå› ä¸ºä½ æ‰€æœ‰çš„è§£æåçš„æ³¨å†ŒåŠ¨ä½œï¼Œéƒ½ä¼šæŠŠ Bean å®šä¹‰ä¿¡æ¯æ”¾å…¥åˆ°è¿™ä¸ªç±»ä¸­ã€‚
> - é‚£ä¹ˆåœ¨å®ç°çš„æ—¶å€™å°±è®¾è®¡å¥½æ¥å£çš„å®ç°å±‚çº§å…³ç³»ï¼ŒåŒ…æ‹¬æˆ‘ä»¬éœ€è¦å®šä¹‰å‡º Bean å®šä¹‰çš„è¯»å–æ¥å£ `BeanDefinitionReader`
    ä»¥åŠåšå¥½å¯¹åº”çš„å®ç°ç±»ï¼Œåœ¨å®ç°ç±»ä¸­å®Œæˆå¯¹ Bean å¯¹è±¡çš„è§£æå’Œæ³¨å†Œ

![å›¾ 6-3](https://bugstack.cn/assets/images/spring/spring-6-03.png)

èµ„æºè§£æå™¨ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç‹¬ç«‹,æˆ‘ä»¬å°†Loaderå’ŒReaderè¿›è¡Œåˆ†å¼€å®ç°,å‰è€…çš„åŠŸèƒ½ä¸ºå¾—åˆ°Resoure,resourceä½œä¸ºæ¥å£è§„èŒƒäº†åŠŸèƒ½ä¸ºè·å–Inputstream.

æœ€ç»ˆåœ¨ DefaultResourceLoader ä¸­åšå…·ä½“çš„è°ƒç”¨ ä¸‰å¤§å®ç°çš„ä¸åŒResource.

åè€…ä½œä¸ºè¯»å–è§£æinputstreamçš„æ³¨å†Œå™¨æ¥å®ç°.é‚£ä¹ˆåœ¨å®ç°çš„æ—¶å€™å°±è®¾è®¡å¥½æ¥å£çš„å®ç°å±‚çº§å…³ç³»ï¼ŒåŒ…æ‹¬æˆ‘ä»¬éœ€è¦å®šä¹‰å‡º Bean
å®šä¹‰çš„è¯»å–æ¥å£ `BeanDefinitionReader` ä»¥åŠåšå¥½å¯¹åº”çš„å®ç°ç±»ï¼Œåœ¨å®ç°ç±»ä¸­å®Œæˆå¯¹ Bean å¯¹è±¡çš„è§£æå’Œæ³¨å†Œ

> - æ¥å£ï¼šBeanDefinitionReaderã€æŠ½è±¡ç±»ï¼šAbstractBeanDefinitionReaderã€å®ç°ç±»ï¼šXmlBeanDefinitionReaderï¼Œè¿™ä¸‰éƒ¨åˆ†å†…å®¹ä¸»è¦æ˜¯åˆç†æ¸…æ™°çš„å¤„ç†äº†èµ„æºè¯»å–åçš„æ³¨å†Œ
    Bean å®¹å™¨æ“ä½œã€‚*æ¥å£ç®¡å®šä¹‰ï¼ŒæŠ½è±¡ç±»å¤„ç†éæ¥å£åŠŸèƒ½å¤–çš„æ³¨å†ŒBeanç»„ä»¶å¡«å……ï¼Œæœ€ç»ˆå®ç°ç±»å³å¯åªå…³å¿ƒå…·ä½“çš„ä¸šåŠ¡å®ç°*

æ¥å£è´Ÿè´£è¦å®ç°çš„åŠŸèƒ½,æŠ½è±¡ç±»è´Ÿè´£åˆå§‹åŒ–æ¥å£å®ç°åŠŸèƒ½æ‰€éœ€çš„å˜é‡æˆ–è€…æ–¹æ³•,å®ç°ç±»è´Ÿè´£å®ç°æ¥å£åŠŸèƒ½çš„ä¸šåŠ¡.èŒè´£åˆ’åˆ†æ˜ç¡®.

ğŸ‘‡å¦å¤–æœ¬ç« èŠ‚è¿˜å‚è€ƒ Spring æºç ï¼Œåšäº†ç›¸åº”æ¥å£çš„é›†æˆå’Œå®ç°çš„å…³ç³»ï¼Œè™½ç„¶è¿™äº›æ¥å£ç›®å‰è¿˜å¹¶æ²¡æœ‰å¤ªå¤§çš„ä½œç”¨ï¼Œä½†éšç€æ¡†æ¶çš„é€æ­¥å®Œå–„ï¼Œå®ƒä»¬ä¹Ÿä¼šå‘æŒ¥ä½œç”¨ã€‚

![å›¾ 6-4](https://bugstack.cn/assets/images/spring/spring-6-04.png)

> - BeanFactoryï¼Œå·²ç»å­˜åœ¨çš„ Bean å·¥å‚æ¥å£ç”¨äºè·å– Bean å¯¹è±¡ï¼Œè¿™æ¬¡æ–°å¢åŠ äº†æŒ‰ç…§ç±»å‹è·å– Bean
    çš„æ–¹æ³•ï¼š`<T> T getBean(String name, Class<T> requiredType)`
> - ListableBeanFactoryï¼Œæ˜¯ä¸€ä¸ªæ‰©å±• Bean å·¥å‚æ¥å£çš„æ¥å£ï¼Œæ–°å¢åŠ äº† `getBeansOfType`ã€`getBeanDefinitionNames()` æ–¹æ³•ï¼Œåœ¨
    Spring æºç ä¸­è¿˜æœ‰å…¶ä»–æ‰©å±•æ–¹æ³•ã€‚
> - HierarchicalBeanFactoryï¼Œåœ¨ Spring æºç ä¸­å®ƒæä¾›äº†å¯ä»¥è·å–çˆ¶ç±» BeanFactory æ–¹æ³•ï¼Œå±äºæ˜¯ä¸€ç§æ‰©å±•å·¥å‚çš„å±‚æ¬¡å­æ¥å£ã€‚*
    Sub-interface implemented by bean factories that can be part of a hierarchy.*
> - AutowireCapableBeanFactoryï¼Œæ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–å¤„ç†Beanå·¥å‚é…ç½®çš„æ¥å£ï¼Œç›®å‰æ¡ˆä¾‹å·¥ç¨‹ä¸­è¿˜æ²¡æœ‰åšç›¸åº”çš„å®ç°ï¼Œåç»­é€æ­¥å®Œå–„ã€‚
> - ConfigurableBeanFactoryï¼Œå¯è·å– BeanPostProcessorã€BeanClassLoaderç­‰çš„ä¸€ä¸ªé…ç½®åŒ–æ¥å£ã€‚
> - ConfigurableListableBeanFactoryï¼Œæä¾›åˆ†æå’Œä¿®æ”¹Beanä»¥åŠé¢„å…ˆå®ä¾‹åŒ–çš„æ“ä½œæ¥å£ï¼Œä¸è¿‡ç›®å‰åªæœ‰ä¸€ä¸ª getBeanDefinition æ–¹æ³•ã€‚

éµå¾ªæ¥å£æä¾›æ–¹æ³•,æŠ½è±¡ç±»å®ç°åˆå§‹åŒ–
å¯èƒ½æ˜¯ç»™ä¸‹ä¸€ç« contexté¢„çƒ­å§..

## å®ç°åº”ç”¨ä¸Šä¸‹æ–‡

åœ¨å¯¹å®¹å™¨ä¸­ Bean çš„å®ä¾‹åŒ–è¿‡ç¨‹æ·»åŠ æ‰©å±•æœºåˆ¶çš„åŒæ—¶ï¼Œéœ€è¦æŠŠç›®å‰å…³äº Spring.xml åˆå§‹åŒ–å’ŒåŠ è½½ç­–ç•¥è¿›è¡Œä¼˜åŒ–

> DefaultListableBeanFactoryã€XmlBeanDefinitionReaderï¼Œæ˜¯æˆ‘ä»¬åœ¨ç›®å‰ Spring æ¡†æ¶ä¸­å¯¹äºæœåŠ¡åŠŸèƒ½æµ‹è¯•çš„ä½¿ç”¨æ–¹å¼ï¼Œå®ƒèƒ½å¾ˆå¥½çš„ä½“ç°å‡º
> Spring æ˜¯å¦‚ä½•å¯¹ xml åŠ è½½ä»¥åŠæ³¨å†ŒBeanå¯¹è±¡çš„æ“ä½œè¿‡ç¨‹ï¼Œä½†è¿™ç§æ–¹å¼æ˜¯é¢å‘ Spring æœ¬èº«çš„ï¼Œè¿˜ä¸å…·å¤‡ä¸€å®šçš„æ‰©å±•æ€§ã€‚
> å°±åƒæˆ‘ä»¬ç°åœ¨éœ€è¦æä¾›å‡ºä¸€ä¸ªå¯ä»¥åœ¨ Bean åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå®Œæˆå¯¹ Bean å¯¹è±¡çš„æ‰©å±•æ—¶ï¼Œå°±å¾ˆéš¾åšåˆ°è‡ªåŠ¨åŒ–å¤„ç†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æŠŠ Bean
> å¯¹è±¡æ‰©å±•æœºåˆ¶åŠŸèƒ½å’Œå¯¹ Spring æ¡†æ¶ä¸Šä¸‹æ–‡çš„åŒ…è£…èåˆèµ·æ¥ï¼Œå¯¹å¤–æä¾›å®Œæ•´çš„æœåŠ¡

è®¾è®¡ï¼š

![img](https://bugstack.cn/assets/images/spring/spring-7-02.png)

> æ»¡è¶³äºå¯¹ Bean å¯¹è±¡æ‰©å±•çš„ä¸¤ä¸ªæ¥å£ï¼Œå…¶å®ä¹Ÿæ˜¯ Spring æ¡†æ¶ä¸­éå¸¸å…·æœ‰é‡é‡çº§çš„ä¸¤ä¸ªæ¥å£ï¼šBeanFactoryPostProcessor å’Œ
> BeanPostProcessorï¼Œä¹Ÿå‡ ä¹æ˜¯å¤§å®¶åœ¨ä½¿ç”¨ Spring æ¡†æ¶é¢å¤–æ–°å¢å¼€å‘è‡ªå·±ç»„å»ºéœ€æ±‚çš„ä¸¤ä¸ªå¿…å¤‡æ¥å£ã€‚
> BeanFactoryPostProcessorï¼Œæ˜¯ç”± Spring æ¡†æ¶ç»„å»ºæä¾›çš„å®¹å™¨æ‰©å±•æœºåˆ¶ï¼Œå…è®¸åœ¨ Bean å¯¹è±¡æ³¨å†Œåä½†æœªå®ä¾‹åŒ–ä¹‹å‰ï¼Œå¯¹ Bean çš„å®šä¹‰ä¿¡æ¯
> BeanDefinition æ‰§è¡Œä¿®æ”¹æ“ä½œã€‚
> BeanPostProcessorï¼Œä¹Ÿæ˜¯ Spring æä¾›çš„æ‰©å±•æœºåˆ¶ï¼Œä¸è¿‡ BeanPostProcessor æ˜¯åœ¨ Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹åä¿®æ”¹ Bean å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢
> Bean å¯¹è±¡ã€‚è¿™éƒ¨åˆ†ä¸åé¢è¦å®ç°çš„ AOP æœ‰ç€å¯†åˆ‡çš„å…³ç³»ã€‚
> åŒæ—¶å¦‚æœåªæ˜¯æ·»åŠ è¿™ä¸¤ä¸ªæ¥å£ï¼Œä¸åšä»»ä½•åŒ…è£…ï¼Œé‚£ä¹ˆå¯¹äºä½¿ç”¨è€…æ¥è¯´è¿˜æ˜¯éå¸¸éº»çƒ¦çš„ã€‚æˆ‘ä»¬å¸Œæœ›äºå¼€å‘ Spring çš„ä¸Šä¸‹æ–‡æ“ä½œç±»ï¼ŒæŠŠç›¸åº”çš„
> XML åŠ è½½ ã€æ³¨å†Œã€å®ä¾‹åŒ–ä»¥åŠæ–°å¢çš„ä¿®æ”¹å’Œæ‰©å±•éƒ½èåˆè¿›å»ï¼Œè®© Spring å¯ä»¥è‡ªåŠ¨æ‰«æåˆ°æˆ‘ä»¬çš„æ–°å¢æœåŠ¡ï¼Œä¾¿äºç”¨æˆ·ä½¿ç”¨ã€‚

![å›¾ 7-3](https://bugstack.cn/assets/images/spring/spring-7-03.png)

å…¶ä¸­çš„BeanFactoryPostProcessoræ˜¯åœ¨æ‰€æœ‰BeanDefinitionåŠ è½½å®Œæˆä¹‹åï¼Œå®ä¾‹åŒ–Beanå¯¹è±¡ä¹‹å‰ï¼Œæä¾›ä¿®æ”¹BeanDefinitionå±æ€§çš„æœºåˆ¶ï¼ŒBeanPostProcessoræ˜¯ä¿®æ”¹beanå¯¹è±¡çš„æ‹“å±•ç‚¹ï¼Œæœ‰ç€åˆå§‹åŒ–å‰åæ‰§è¡Œçš„æ–¹æ³•ã€‚

applicationContextæ˜¯contextçš„ä¸­å¿ƒæ¥å£ï¼ŒConfigurableApplicationContextæ˜¯æä¾›äº†æ ¸å¿ƒæ–¹æ³•refreshã€‚

---

- AbstractApplicationContext ç»§æ‰¿ DefaultResourceLoader æ˜¯ä¸ºäº†å¤„ç† `spring.xml` é…ç½®èµ„æºçš„åŠ è½½ã€‚
- ä¹‹åæ˜¯åœ¨ refresh() å®šä¹‰å®ç°è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
    -
        1. åˆ›å»º BeanFactoryï¼Œå¹¶åŠ è½½ BeanDefinition
    -
        1. è·å– BeanFactory
    -
        1. åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰ï¼Œæ‰§è¡Œ BeanFactoryPostProcessor (Invoke factory processors registered as beans in the
           context.)
    -
        1. BeanPostProcessor éœ€è¦æå‰äºå…¶ä»– Bean å¯¹è±¡å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œæ³¨å†Œæ“ä½œ
    -
        1. æå‰å®ä¾‹åŒ–å•ä¾‹Beanå¯¹è±¡
- å¦å¤–æŠŠå®šä¹‰å‡ºæ¥çš„æŠ½è±¡æ–¹æ³•ï¼ŒrefreshBeanFactory()ã€getBeanFactory() ç”±åé¢çš„ç»§æ‰¿æ­¤æŠ½è±¡ç±»çš„å…¶ä»–æŠ½è±¡ç±»å®ç°ã€‚

---

- åœ¨ refreshBeanFactory() ä¸­ä¸»è¦æ˜¯è·å–äº† `DefaultListableBeanFactory`
  çš„å®ä¾‹åŒ–ä»¥åŠå¯¹èµ„æºé…ç½®çš„åŠ è½½æ“ä½œ `loadBeanDefinitions(beanFactory)`ï¼Œåœ¨åŠ è½½å®Œæˆåå³å¯å®Œæˆå¯¹ spring.xml é…ç½®æ–‡ä»¶ä¸­ Bean
  å¯¹è±¡çš„å®šä¹‰å’Œæ³¨å†Œï¼ŒåŒæ—¶ä¹ŸåŒ…æ‹¬å®ç°äº†æ¥å£ BeanFactoryPostProcessorã€BeanPostProcessor çš„é…ç½® Bean ä¿¡æ¯ã€‚
- ä½†æ­¤æ—¶èµ„æºåŠ è½½è¿˜åªæ˜¯å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡ç±»æ–¹æ³• `loadBeanDefinitions(DefaultListableBeanFactory beanFactory)`ï¼Œç»§ç»­ç”±å…¶ä»–æŠ½è±¡ç±»ç»§æ‰¿å®ç°ã€‚

---

åœ¨classpathXmlApplicationå½“ä¸­åšçš„æ˜¯è½½å…¥å…·ä½“é…ç½®æ–‡æ¡£çš„è·¯å¾„

---

åœ¨abstractAutowireCapableFactoryå½“ä¸­åšçš„æ˜¯åœ¨createBeanè¿‡ç¨‹å½“ä¸­æ·»åŠ åˆå§‹åŒ–æ–¹æ³•ï¼Œå³InitializeBeanä½œç”¨æ˜¯å¯¹å¡«å……å±æ€§äº†çš„beanè¿›è¡Œç±»ä¼¼aopçš„æ“ä½œã€‚

>
> å®ç° BeanPostProcessor æ¥å£åï¼Œä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼Œ`postProcessBeforeInitialization`ã€`postProcessAfterInitialization`
> ï¼Œåˆ†åˆ«ä½œç”¨äº Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–å‰åçš„é¢å¤–å¤„ç†ã€‚
>
> ä¹Ÿå°±æ˜¯éœ€è¦åœ¨åˆ›å»º Bean å¯¹è±¡æ—¶ï¼Œåœ¨ createBean æ–¹æ³•ä¸­æ·»åŠ  `initializeBean(beanName, bean, beanDefinition);`
> æ“ä½œã€‚è€Œè¿™ä¸ªæ“ä½œä¸»è¦ä¸»è¦æ˜¯å¯¹äºæ–¹æ³• `applyBeanPostProcessorsBeforeInitialization`
> ã€`applyBeanPostProcessorsAfterInitialization` çš„ä½¿ç”¨ã€‚
>
> å¦å¤–éœ€è¦æä¸€ä¸‹ï¼ŒapplyBeanPostProcessorsBeforeInitializationã€applyBeanPostProcessorsAfterInitialization
> ä¸¤ä¸ªæ–¹æ³•æ˜¯åœ¨æ¥å£ç±» `AutowireCapableBeanFactory` ä¸­æ–°å¢åŠ çš„ã€‚

ä»£ç é€»è¾‘è¾ƒä¸ºå¤æ‚æ¶‰åŠåˆ°å‰å‡ ç« çš„å†…å®¹æ¯”è¾ƒç»•,å¯ä»¥å°è¯•ä»¥å…¥å£ç±»ä»é«˜å±‚æ¨¡å—åˆ°åº•å±‚æ¨¡å—çš„æ–¹å¼æ‹æ¸…æ¥šé€»è¾‘;

## å®ç°åˆå§‹åŒ–æ–¹æ³•å’Œé”€æ¯æ–¹æ³•

è¯¥å®ç°å¾ˆç®€å•,å¾—ç›Šäºå‰å‡ ç« æ‰€æ­å»ºå¥½çš„é¡¹ç›®ç»“æ„å¯ä»¥å¾ˆè½»æ˜“åœ°æ‹æ¸…æ¥šä»£ç æ€è·¯;

é‚£ä¹ˆé™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¸Œæœ›å¯ä»¥åœ¨ Bean
åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ‰§è¡Œä¸€äº›æ“ä½œã€‚æ¯”å¦‚å¸®æˆ‘ä»¬åšä¸€äº›æ•°æ®çš„åŠ è½½æ‰§è¡Œï¼Œé“¾æ¥æ³¨å†Œä¸­å¿ƒæš´éœ²RPCæ¥å£ä»¥åŠåœ¨Webç¨‹åºå…³é—­æ—¶æ‰§è¡Œé“¾æ¥æ–­å¼€ï¼Œå†…å­˜é”€æ¯ç­‰æ“ä½œã€‚*
å¦‚æœè¯´æ²¡æœ‰Springæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ã€é™æ€æ–¹æ³•ä»¥åŠæ‰‹åŠ¨è°ƒç”¨çš„æ–¹å¼å®ç°ï¼Œä½†è¿™æ ·çš„å¤„ç†æ–¹å¼ç»ˆç©¶ä¸å¦‚æŠŠè¯¸å¦‚æ­¤ç±»çš„æ“ä½œéƒ½äº¤ç»™
Spring å®¹å™¨æ¥ç®¡ç†æ›´åŠ åˆé€‚ã€‚*

![img](https://bugstack.cn/assets/images/spring/spring-8-03.png)

> å¯èƒ½é¢å¯¹åƒ Spring è¿™æ ·åºå¤§çš„æ¡†æ¶ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£å®šä¹‰ä½¿ç”¨æˆ–è€…xmlé…ç½®ï¼Œå®Œæˆçš„ä¸€ç³»åˆ—æ‰©å±•æ€§æ“ä½œï¼Œéƒ½è®© Spring æ¡†æ¶çœ‹ä¸Šå»å¾ˆç¥ç§˜ã€‚å…¶å®å¯¹äºè¿™æ ·åœ¨
> Bean å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­é¢å¤–æ·»åŠ çš„å¤„ç†æ“ä½œï¼Œæ— éå°±æ˜¯é¢„å…ˆæ‰§è¡Œäº†ä¸€ä¸ªå®šä¹‰å¥½çš„æ¥å£æ–¹æ³•æˆ–è€…æ˜¯åå°„è°ƒç”¨ç±»ä¸­xmlä¸­é…ç½®çš„æ–¹æ³•ï¼Œæœ€ç»ˆä½ åªè¦æŒ‰ç…§æ¥å£å®šä¹‰å®ç°ï¼Œå°±ä¼šæœ‰
> Spring å®¹å™¨åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­è¿›è¡Œè°ƒç”¨è€Œå·²ã€‚

![å›¾ 8-4](https://bugstack.cn/assets/images/spring/spring-8-04.png)
åœ¨ spring.xml é…ç½®ä¸­æ·»åŠ  init-methodã€destroy-method ä¸¤ä¸ªæ³¨è§£ï¼Œåœ¨é…ç½®æ–‡ä»¶åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠæ³¨è§£é…ç½®ä¸€å¹¶å®šä¹‰åˆ° BeanDefinition
çš„å±æ€§å½“ä¸­ã€‚è¿™æ ·åœ¨ initializeBean åˆå§‹åŒ–æ“ä½œçš„å·¥ç¨‹ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼æ¥è°ƒç”¨é…ç½®åœ¨ Bean
å®šä¹‰å±æ€§å½“ä¸­çš„æ–¹æ³•ä¿¡æ¯äº†ã€‚å¦å¤–å¦‚æœæ˜¯æ¥å£å®ç°çš„æ–¹å¼ï¼Œé‚£ä¹ˆç›´æ¥å¯ä»¥é€šè¿‡ Bean å¯¹è±¡è°ƒç”¨å¯¹åº”æ¥å£å®šä¹‰çš„æ–¹æ³•å³å¯ï¼Œ((
InitializingBean) bean).afterPropertiesSet()ï¼Œä¸¤ç§æ–¹å¼è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

é™¤äº†åœ¨åˆå§‹åŒ–åšçš„æ“ä½œå¤–ï¼Œdestroy-method å’Œ DisposableBean æ¥å£çš„å®šä¹‰ï¼Œéƒ½ä¼šåœ¨ Bean å¯¹è±¡åˆå§‹åŒ–å®Œæˆé˜¶æ®µï¼Œæ‰§è¡Œæ³¨å†Œé”€æ¯æ–¹æ³•çš„ä¿¡æ¯åˆ°
DefaultSingletonBeanRegistry ç±»ä¸­çš„ disposableBeans
å±æ€§é‡Œï¼Œè¿™æ˜¯ä¸ºäº†åç»­ç»Ÿä¸€è¿›è¡Œæ“ä½œã€‚è¿™é‡Œè¿˜æœ‰ä¸€æ®µé€‚é…å™¨çš„ä½¿ç”¨ï¼Œå› ä¸ºåå°„è°ƒç”¨å’Œæ¥å£ç›´æ¥è°ƒç”¨ï¼Œæ˜¯ä¸¤ç§æ–¹å¼ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨é€‚é…å™¨è¿›è¡ŒåŒ…è£…ï¼Œä¸‹æ–‡ä»£ç è®²è§£ä¸­å‚è€ƒ
DisposableBeanAdapter çš„å…·ä½“å®ç°
-å…³äºé”€æ¯æ–¹æ³•éœ€è¦åœ¨è™šæ‹Ÿæœºæ‰§è¡Œå…³é—­ä¹‹å‰è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªæ³¨å†Œé’©å­çš„æ“ä½œï¼Œå¦‚ï¼šRuntime.getRuntime()
.addShutdownHook(new Thread(() -> System.out.println("closeï¼"))); è¿™æ®µä»£ç ä½ å¯ä»¥æ‰§è¡Œæµ‹è¯•ï¼Œå¦å¤–ä½ å¯ä»¥ä½¿ç”¨æ‰‹åŠ¨è°ƒç”¨
ApplicationContext.close æ–¹æ³•å…³é—­å®¹å™¨ã€‚
